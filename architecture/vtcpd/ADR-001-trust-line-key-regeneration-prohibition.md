# ADR-001: Trust Line Key Regeneration Prohibition

## Status
Accepted

## Date
2025-01-19

## Context
In the VTCP (Value Transfer Consensus Protocol) network, trust lines form the fundamental basis for value transfer between participants. Each trust line is secured by cryptographic key pairs generated by both participants during trust line establishment. These key pairs serve multiple critical functions:

1. **Transaction Authentication**: All trust line modifications must be signed by both participants using their respective private keys
2. **Conflict Resolution**: The BTC Federation must validate signatures on conflicting transactions to resolve disputes
3. **Critical Operations Validation**: Specific trust line operations (deposits with potential trust line opening, and withdrawals with potential trust line closure) require signature verification by the BTC Federation
4. **Audit Trail**: Historical transactions maintain their cryptographic integrity through persistent key associations

### Current Implementation
The system currently includes a `PublicKeysSharingSourceTransaction` that theoretically allows key regeneration on active trust lines. However, this transaction is designed to terminate immediately to prevent unauthorized key regeneration.

### BTC Federation Integration Requirements
The BTC Federation operates as the dispute resolution and validation authority for the VTCP network. For the BTC Federation to function properly, it must:
- Maintain knowledge of all public keys associated with active trust lines
- Receive public keys during the deposit procedure when trust lines are established (see [BTC ⟷ vTCP Custody Protocol - Deposit Flow](../btc-federation/protocols/btc-vtcp-custody/protocol_btc<>vtcp_custody_deposit.md))
- Validate signatures on critical trust line operations (deposits and withdrawals) using known public keys
- Resolve conflicts by verifying historical transaction signatures

### Security and Operational Concerns
Allowing key regeneration on active trust lines would create several critical vulnerabilities:

1. **BTC Federation Blindness**: If participants regenerate keys outside BTC Federation knowledge, the BTC Federation cannot validate new operations
2. **Historical Integrity Loss**: Previously signed transactions become unverifiable if keys are changed
3. **Conflict Resolution Failure**: The BTC Federation cannot arbitrate disputes involving transactions signed with unknown keys
4. **Coordination Attacks**: Malicious participants could regenerate keys to avoid BTC Federation oversight

## Decision
We have decided to **prohibit key regeneration on active trust lines** with the following constraints:

### Prohibition Rules
1. **Active Trust Line Restriction**: Key regeneration is strictly forbidden while a trust line contains any funds or remains in an active state
2. **BTC Federation Knowledge Requirement**: The BTC Federation must be aware of and approve all public keys used for trust line operations
3. **Immutable Key Policy**: Once established and known to the BTC Federation, trust line keys remain fixed for the lifetime of that trust line instance

### Permitted Key Regeneration Scenario
Key regeneration is **only permitted** under the following specific conditions:
1. All funds have been completely withdrawn from the trust line
2. The trust line has been formally closed and marked as terminated
3. A new deposit request is initiated, creating a **new trust line instance**
4. The BTC Federation receives and validates new public keys during the new deposit procedure

### Implementation Enforcement
- The `PublicKeysSharingSourceTransaction` must continue to terminate immediately when called on active trust lines
- Key regeneration attempts on active trust lines must be logged and rejected
- New deposit procedures must generate fresh keys and establish new trust line instances rather than reusing closed trust lines

### BTC Federation Integration Protocol
- All public keys must be transmitted to the BTC Federation during deposit procedures (as specified in [BTC ⟷ vTCP Custody Protocol - Deposit Flow](../btc-federation/protocols/btc-vtcp-custody/protocol_btc<>vtcp_custody_deposit.md))
- The BTC Federation must reject new deposit attempts that try to reuse keys from previously closed trust lines
- Key validation must occur before any trust line operations are permitted

## Consequences

### Positive
- **BTC Federation Authority Maintained**: The BTC Federation retains full capability to validate operations and resolve conflicts
- **Historical Integrity Preserved**: All historical transactions remain cryptographically verifiable
- **Security Model Consistency**: Clear key lifecycle prevents security gaps and coordination attacks
- **Operational Predictability**: Participants and the BTC Federation have clear expectations about key persistence
- **Audit Compliance**: Complete transaction history remains verifiable for regulatory and audit purposes

### Negative
- **Key Compromise Risk**: If private keys are compromised, the trust line cannot be secured until closure and re-establishment
- **Operational Inflexibility**: Participants cannot refresh keys for security hygiene without closing trust lines
- **Trust Line Lifecycle Complexity**: Full closure and re-establishment required for key changes

### Risk Mitigation Strategies
- **Secure Key Storage**: Implement robust key storage and backup procedures to prevent compromise
- **Trust Line Closure Procedures**: Establish clear, efficient procedures for trust line closure and re-establishment
- **Monitoring and Detection**: Implement monitoring for key compromise indicators
- **Emergency Procedures**: Define emergency response procedures for suspected key compromise scenarios

## Implementation Requirements

### Code Enforcement
- `PublicKeysSharingSourceTransaction` must validate trust line state before proceeding
- Active trust lines must immediately terminate key regeneration attempts
- Logging must capture all attempted key regeneration for security monitoring

### BTC Federation Integration
- Deposit procedures must include public key transmission and validation (following [BTC ⟷ vTCP Custody Protocol - Deposit Flow](../btc-federation/protocols/btc-vtcp-custody/protocol_btc<>vtcp_custody_deposit.md))
- BTC Federation must maintain persistent mapping of trust line instances to authorized keys
- Key reuse validation must be implemented in deposit acceptance logic

### Documentation and Training
- Clear procedures for trust line closure and re-establishment
- Security best practices for key management and storage
- Incident response procedures for key compromise scenarios

## Related Decisions
- Trust line lifecycle management procedures
- BTC Federation integration protocols
- Cryptographic key management standards
- Conflict resolution mechanisms

## Implementation Notes
- This decision reinforces existing code behavior but formalizes the architectural reasoning
- Future key management improvements must maintain federation oversight requirements
- Any changes to this policy require careful consideration of federation integration impacts
